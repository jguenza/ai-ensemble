<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI-Ensemble</title>
<style>
body {
  font-family: Arial, sans-serif;

  margin: 20px;
}
textarea {
  width: 100%;
  height: 120px;
}
button {
  margin-top: 10px;
  padding: 6px 12px;
}
.panel {
  border: 1px solid #ccc;
  padding: 10px;
  margin-bottom: 20px;
}
.output {
  white-space: pre-wrap;
  background: #f7f7f7;
  padding: 10px;
  margin-top: 10px;
}
.hidden {
  display: none;
}
</style>
</head>

<body>

<h1>AI-Ensemble</h1>

<!-- LOGIN -->
<div id="loginPanel" class="panel">
  <h3>Login</h3>
  <input type="password" id="passwordInput" placeholder="Password"><br>
  <input type="text" id="clientInput" placeholder="Client ID (optional)"><br>
  <button onclick="login()">Login</button>
  <div id="loginError" style="color:red;"></div>
</div>

<!-- APP -->
<div id="appPanel" class="hidden">

  <div class="panel">
    <h3>Scenario — prompt engineering</h3>
    <textarea id="scenarioInput" placeholder="Describe the situation or challenge..."></textarea>
    <button onclick="sendPrompt('scenario')">Send</button>
    <div id="scenarioOutput" class="output"></div>
  </div>

  <div class="panel">
    <h3>Ensemble — alternative reasoning</h3>
    <textarea id="ensembleInput" placeholder="Paste scenario output here..."></textarea>
    <button onclick="sendPrompt('ensemble')">Send</button>
    <div id="ensembleOutput" class="output"></div>
  </div>

  <div class="panel">
    <h3>Compiler — grounded synthesis</h3>
    <textarea id="compilerInput" placeholder="Paste ensemble output here..."></textarea>
    <button onclick="sendPrompt('compiler')">Send</button>
    <div id="compilerOutput" class="output"></div>
  </div>

</div>

<script>
const API_BASE = "https://statsapp-47vj4.ondigitalocean.app";

/* ---------------- LOGIN ---------------- */

async function login() {
  const password = document.getElementById("passwordInput").value;
  const clientId = document.getElementById("clientInput").value;
  const errorBox = document.getElementById("loginError");

  try {
    const res = await fetch(API_BASE + "/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password, client_id: clientId })
    });

    const data = await res.json();

    if (!data.ok) {
      errorBox.innerText = data.error || "Login failed";
      return;
    }

    // ✅ STORE TOKEN — THIS WAS MISSING
    sessionStorage.setItem("ai_ensemble_token", data.access_token);

    // Switch UI
    document.getElementById("loginPanel").classList.add("hidden");
    document.getElementById("appPanel").classList.remove("hidden");

  } catch (err) {
    errorBox.innerText = "Login error";
  }
}

/* ---------------- CHAT ---------------- */

async function sendPrompt(stage) {
  const token = sessionStorage.getItem("ai_ensemble_token");
  if (!token) {
    alert("Not logged in");
    return;
  }

  const input = document.getElementById(stage + "Input");
  const output = document.getElementById(stage + "Output");

  output.innerText = "Working...";

  try {
    const res = await fetch(API_BASE + "/api/chat", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token   // ✅ REQUIRED
      },
      body: JSON.stringify({ message: input.value })
    });

    const data = await res.json();

    if (!data.ok) {
      output.innerText = data.error || "Error";
      return;
    }

    // Handle planes or single answer
    if (data.planes) {
      let txt = "";
      for (const k in data.planes) {
        txt += `=== ${k.toUpperCase()} ===\n${data.planes[k]}\n\n`;
      }
      output.innerText = txt;
    } else {
      output.innerText = data.answer || "No response";
    }

  } catch (err) {
    output.innerText = "Backend error";
  }
}

/* ---------------- AUTO-RESTORE SESSION ---------------- */

if (sessionStorage.getItem("ai_ensemble_token")) {
  document.getElementById("loginPanel").classList.add("hidden");
  document.getElementById("appPanel").classList.remove("hidden");
}
</script>

</body>
</html>
